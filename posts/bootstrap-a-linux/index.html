<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.53" />



<link rel="canonical" href="http://svanellewee.github.io/posts/bootstrap-a-linux/">


    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/solarized_dark.min.css">
    <title>Bootstrap a Linux - Peculiar Computing</title>
    
<meta name="description" content="How to bootstrap your a baby linux operating system using Ubuntu. Why would I do this? I want to understand the tools I use. Docker is an extension of an idea that has actually been in the kernel for a while using cgroups etc. (Just a nicer package) BSD jails etc. What other treasures exists in the kernel? The only way to know is to learn more about linux. How do you learn about a project?">

<meta property="og:title" content="Bootstrap a Linux - Peculiar Computing">
<meta property="og:type" content="article">
<meta property="og:url" content="http://svanellewee.github.io/posts/bootstrap-a-linux/">
<meta property="og:image" content="http://svanellewee.github.io/images/default.png">
<meta property="og:site_name" content="Peculiar Computing">
<meta property="og:description" content="How to bootstrap your a baby linux operating system using Ubuntu. Why would I do this? I want to understand the tools I use. Docker is an extension of an idea that has actually been in the kernel for a while using cgroups etc. (Just a nicer package) BSD jails etc. What other treasures exists in the kernel? The only way to know is to learn more about linux. How do you learn about a project?">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="Peculiar Computing">
<meta name="twitter:url" content="http://svanellewee.github.io/posts/bootstrap-a-linux/">
<meta name="twitter:title" content="Bootstrap a Linux - Peculiar Computing">
<meta name="twitter:description" content="How to bootstrap your a baby linux operating system using Ubuntu. Why would I do this? I want to understand the tools I use. Docker is an extension of an idea that has actually been in the kernel for a while using cgroups etc. (Just a nicer package) BSD jails etc. What other treasures exists in the kernel? The only way to know is to learn more about linux. How do you learn about a project?">
<meta name="twitter:image" content="http://svanellewee.github.io/images/default.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"http://svanellewee.github.io/"
    },
    "headline": "Bootstrap a Linux - Peculiar Computing",
    "image": {
      "@type": "ImageObject",
      "url": "http://svanellewee.github.io/images/default.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2019-01-03T21:42:31JST",
    "dateModified": "2019-01-03T21:42:31JST",
    "author": {
      "@type": "Person",
      "name": "Peculiar Computing"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Peculiar Computing",
      "logo": {
        "@type": "ImageObject",
        "url": "http://svanellewee.github.io/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "How to bootstrap your a baby linux operating system using Ubuntu. Why would I do this? I want to understand the tools I use. Docker is an extension of an idea that has actually been in the kernel for a while using cgroups etc. (Just a nicer package) BSD jails etc. What other treasures exists in the kernel? The only way to know is to learn more about linux. How do you learn about a project?"
  }
</script>


    <link href="http://svanellewee.github.io/css/styles.css" rel="stylesheet">
    

  </head>

  <body>
    
    
    

    <header class="l-header">
      <nav class="navbar navbar-default">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://svanellewee.github.io/">Peculiar Computing</a>
          </div>

          

        </div>
      </nav>
    </header>

    <main>
      <div class="container">
        
<div class="row">
  <div class="col-md-8">

    <nav class="p-crumb">
      <ol class="breadcrumb">
        <li><a href="http://svanellewee.github.io/"><i class="fa fa-home" aria-hidden="true"></i></a></li>
        
        <li itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="http://svanellewee.github.io/posts/" itemprop="url"><span itemprop="title">posts</span></a></li>
        
        <li class="active">Bootstrap a Linux</li>
      </ol>
    </nav>

    <article class="single">
  <header>
    <ul class="p-facts">
      <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2019-01-03T21:42:31JST">Jan 3, 2019</time></li>
      <li><i class="fa fa-bookmark" aria-hidden="true"></i><a href="http://svanellewee.github.io/posts/">posts</a></li>
      
    </ul>

    <h1 class="title">Bootstrap a Linux</h1>
  </header>

  

  <div class="article-body">

<h1 id="how-to-bootstrap-your-a-baby-linux-operating-system-using-ubuntu">How to bootstrap your a baby linux operating system using Ubuntu.</h1>

<h2 id="why-would-i-do-this">Why would I do this?</h2>

<p>I want to understand the tools I use. Docker is an extension of an idea that has actually been in the kernel for a while using cgroups etc. (Just a nicer package)
BSD jails etc.
What other treasures exists in the kernel? The only way to know is to learn more about linux.
How do you learn about a project? Kafka? Kubernetes? Install it! But oh, how does one install linux? You can do it using your package manager. But you didnt learn much did you?</p>

<h2 id="install-from-scratch">Install from scratch?</h2>

<p>Why not linux from scratch? I have a life. gcc to cross compile gcc to build something else etc etc. Good reasons(Name them) but it takes SO long! Any educational value this project has get&rsquo;s lost in the waiting time. The reasons <em>I</em> stopped was that <em>I</em> actually ended up getting compilation errors after hours of waiting and copy and pasting. I followed instructions, but the results was discouraging.</p>

<h2 id="why-not-gentoo-arch">Why not gentoo/arch?</h2>

<p>Another, copy and paste, follow this method etc etc. better than LFS but still pretty tricky. I have a colleague who actually said &ldquo;I&rsquo;m getting better at installing Gentoo!&rdquo; Pros the bootstrapping compilation steps are done for you. Cons: Still assumes a lot of the user.</p>

<h2 id="just-why">Just why?</h2>

<p>I would like to learn more about Linux tools/systems:
dd? kpartx loopback devices parted/fdisk the linux kernel itself?
Maybe I&rsquo;m a masochist.</p>

<h1 id="assumptions">Assumptions</h1>

<ul>
<li>I&rsquo;m going to use a virtual machine</li>
<li>I&rsquo;m going to assume that we still use a BIOS based machine (What&rsquo;s a BIOS? How old are you? Have you even Doom&rsquo;ed bro?)</li>
</ul>

<h1 id="method">Method</h1>

<ul>
<li>create a virtual disk</li>
<li>partition into a bootable and system partitions</li>
<li>format both partitions as ext2</li>
<li>install a boot loader on the boot partition</li>
<li>copy from your ubuntu kernel and initrd files.</li>
<li>boot the virtual machine using the new virtual disk</li>
</ul>

<h2 id="create-the-virtual-disk">create the virtual disk</h2>

<p>The following creates a file called &ldquo;mink.img&rdquo; filled with 200Megs worth of zeros.</p>

<pre><code class="language-bash">dd if=/dev/zero of=mink.img count=200 bs=1M
</code></pre>

<p>Here is some magic I&rsquo;d like to explain. <code>dd</code> is just a very DUMB copy command. It takes blocks from one file and plop it to another. In this case it copies data from the special <code>zero</code> file and puts it into the new <code>.img</code> file.</p>

<h2 id="partition-into-bootable-and-system-partitions">partition into bootable and system partitions</h2>

<pre><code class="language-bash">parted --script mink.img mklabel msdos mkpart p ext2 1 20 set 1 boot on mkpart p ext2 21 200
</code></pre>

<p><code>parted</code> is a tool you can use to partition the harddisk. There&rsquo;s a graphical version (gparted) also but to be succicnt I&rsquo;m using the encantation.</p>

<p>Let&rsquo;s break it up:</p>

<pre><code class="language-bash">mklabel msdos  # tells parted we're going to use the msdos partition table scheme. This is a legacy thing as far as I understand it.
mkpart p ext2 1 20  # make a 20Meg partition from Meg 1 to Meg 20.
set 1 boot on # make partition 1 bootable
mkpart p ext2 21 200 # make another partition from Meg 21 and Meg 200 
</code></pre>

<h2 id="format-partitions-as-ext2">format partitions as ext2</h2>

<p>To format a file (in this case &ldquo;mink.img&rdquo;) I need to be able to treat it like a drive. That&rsquo;s what loopback devices are. They make the file look like a disk drive that can be mounted or even formatted! So let&rsquo;s see how we format a file like a drive:</p>

<pre><code class="language-bash">kpartx -av mink.img  # create the loopback device and split it over 2 partitions (kpartx splits it up for you)
sleep 10  # this isnt instant, so wait 10 seconds (overkill)
mkfs.ext2  /dev/mapper/loop0p1 # format the boot partition
mkfs.ext2  /dev/mapper/loop0p2 # format the system partition
# Finally mount both files so we can access and work on it.
mount /dev/mapper/loop0p1 /mnt/pocket/boot_mount 
mount /dev/mapper/loop0p2 /mnt/pocket/root_mount
</code></pre>

<p>Now I&rsquo;ve mounted a file as 2 separate partitions. The virtual drive is finally useful. Now we can start installing things.</p>

<h2 id="install-a-boot-loader-on-the-boot-partition">install a boot loader on the boot partition</h2>

<p>The below is still a little fuzzy to me, but so far this seems to have worked:</p>

<pre><code class="language-bash">grub-install --no-floppy  --modules=&quot;biosdisk part_msdos ext2 configfile normal multiboot&quot; --root-directory=/mnt/pocket/boot_mount/ /dev/loop0
</code></pre>

<p>From what i understand I&rsquo;m install a bios based boot loader to my virtual drive&rsquo;s boot partition</p>

<h2 id="copy-from-your-ubuntu-kernel-and-initrd-files">copy from your ubuntu kernel and initrd files.</h2>

<p>So first we make a place for the new files in our drive&rsquo;s system partition.</p>

<pre><code class="language-bash">mkdir -p /mnt/pocket/root_mount/kernels/
</code></pre>

<p>then we copy the linux kernel</p>

<pre><code class="language-bash">cp /boot/vmlinuz-4.10.0-27-generic /mnt/pocket/root_mount/kernels/
</code></pre>

<p>then we copy the matching &ldquo;initial ram disk&rdquo; file. This is like a small linux root filesystem that we can use to access the system before the real system is loaded</p>

<pre><code class="language-bash">cp /boot/initrd.img-4.10.0-27-generic /mnt/pocket/root_mount/kernels/
</code></pre>

<h2 id="boot-the-virtual-machine-using-the-new-virtual-disk">boot the virtual machine using the new virtual disk</h2>

<p>So here we boot into the virtual machine using &ldquo;Qemu&rdquo;.</p>

<pre><code class="language-bash">qemu-system-x86_64 -drive format=raw,file=mink.img -m 1G
</code></pre>

<p>The thing is if everything goes okay the only thing you&rsquo;ll be seeing is the following:</p>

<p><img src="/grub-init.png" alt="Grub Prompt" /></p>

<p>Not very helpful. What now?</p>

<p>Well, it looks like grub prompt is actually pretty simple to use. For example, we can list all the partitions available to the system.</p>

<pre><code class="language-bash">grub&gt; ls 
(hd0) (hd0, msdos2) (hd0, msdos1) (fd0)
</code></pre>

<p>The important entries here would be <code>(hd0, msdos2)</code> and <code>(hd0, msdos1)</code>. Those would be the <code>system</code> and <code>boot</code> partitions respectively. To allow us toe boot the first thing that must be done is to set the current partition to where the kernel is located. Grub allows us to set this using the <code>root</code> command. This is similar to the way one can set DOS&rsquo;s current drive to <code>C:</code> for harddrive or <code>A:</code> for floppy drive.</p>

<pre><code class="language-bash">grub&gt; set root=(hd0, msdos1)
grub&gt; ls /
lost+found/ kernels/
</code></pre>

<p>Our files lives in the <code>kernels</code> directory..</p>

<p><img src="/grub-navigate.png" alt="Grub Navigation" /></p>

<p>To start the os we need to tell grub where the kernel and the initrd files are located. For grub you specify it as follows.</p>

<p><img src="/grub-start-os.png" alt="Grub Starting Linux" /></p>

<p>The <code>boot</code> keyword triggers the actual booting process. <code>Tab</code> actually autocompletes filenames!</p>

<h2 id="booting-success">Booting success!</h2>

<p><img src="/itworked.png" alt="Booted Ubuntu Linux Kernel" /></p>
</div>

  <footer class="article-footer">
    
    
    
    
    
    
  </footer>

</article>


    
  </div>

  <div class="col-md-4">
    
<aside class="l-sidebar">

  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">LATESTS</div>
    </div>
    <div class="list-group">
      
      <a href="http://svanellewee.github.io/posts/bootstrap-a-linux/" class="list-group-item">Bootstrap a Linux</a>
      
    </div>
  </section>

  
  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">CATEGORY</div>
    </div>
    <div class="list-group">
      
    </div>
  </section>
  
  <section class="panel panel-default">
    <div class="panel-heading">
      <div class="panel-title">TAG</div>
    </div>
    <div class="list-group">
      
    </div>
  </section>
  

</aside>


  </div>
</div>

      </div>
    </main>

    <footer class="l-footer">
      <div class="container">
        <p><span class="h-logo">&copy; Peculiar Computing</span></p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_beg">Beg</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>

    <script src="//code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

